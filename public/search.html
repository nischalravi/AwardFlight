<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Award Flights - Search Results</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="./enhancements.css">

  <style>
    /* Mobile improvements */
    @media (max-width: 900px) {
      .container-header { padding: 0.75rem 1rem !important; }
      .nav { gap: 0.75rem !important; overflow-x: auto; white-space: nowrap; }
      .header-actions { display: none; }
    }

    .page-wrap {
      min-height: 100vh;
      padding: 120px 1.25rem 2.5rem;
      background: linear-gradient(135deg, #0a0f1e 0%, #1a2332 100%);
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    .topbar {
      background: #1e2836;
      border: 1px solid #2a3644;
      border-radius: 18px;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }

    .pillrow {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      background: rgba(10,15,30,0.7);
      border: 1px solid #2a3644;
      color: #fff;
      padding: 0.65rem 0.9rem;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 0.95rem;
    }

    .btn {
      border: 1px solid #2a3644;
      background: #2a3644;
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-weight: 800;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, #c5ff68, #a8e050);
      border: none;
      color: #0a0f1e;
    }

    .grid {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 1.25rem;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: #1e2836;
      border: 1px solid #2a3644;
      border-radius: 18px;
      padding: 1.25rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      min-height: 280px;
    }

    .muted {
      color: #8a99b3;
      line-height: 1.65;
    }

    .errorbox {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 14px;
      border: 1px solid rgba(231, 76, 60, 0.35);
      background: rgba(231, 76, 60, 0.12);
      color: #ffd7d2;
      font-weight: 700;
    }

    .flight {
      border: 1px solid #2a3644;
      border-radius: 16px;
      padding: 1rem;
      background: rgba(10,15,30,0.55);
      margin-top: 0.9rem;
    }

    .flight-top {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .price {
      font-weight: 900;
      font-size: 1.25rem;
      color: #c5ff68;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="container-header">
      <a href="index.html" class="logo">
        <div class="logo-icon"></div>
        <span>Award Flights</span>
      </a>

      <nav class="nav" aria-label="Primary navigation">
        <a href="index.html">Home</a>
        <a href="search.html" class="active">Search Flights</a>
        <a href="live-tracker.html">Live Tracker</a>
        <a href="calculator.html">Points Calculator</a>
        <a href="deals.html">Hot Deals</a>
      </nav>

      <div class="header-actions">
        <button class="btn-secondary">Sign In</button>
        <button class="btn-primary">Sign Up</button>
      </div>
    </div>
  </header>

  <main class="page-wrap">
    <div class="shell">
      <div class="topbar">
        <div class="pillrow" id="summaryPills"></div>

        <div class="pillrow">
          <button class="btn" id="btnModify">Modify</button>
          <button class="btn btn-primary" id="btnNewSearch">New Search</button>
        </div>
      </div>

      <div class="grid">
        <aside class="card">
          <h3 style="margin:0 0 0.75rem 0; color:#fff;">Filters</h3>
          <p class="muted" style="margin:0;">
            Filters coming soon. Results require a valid search from the home page.
          </p>
        </aside>

        <section class="card">
          <h3 style="margin:0 0 0.75rem 0; color:#fff;">Results</h3>
          <p class="muted" id="resultsHint" style="margin:0 0 0.75rem 0;"></p>

          <div id="errorBox" class="errorbox" role="alert"></div>
          <div id="results"></div>
        </section>
      </div>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);

    const from = (qs.get('from') || '').trim().toUpperCase();
    const to = (qs.get('to') || '').trim().toUpperCase();
    const date = (qs.get('date') || '').trim();
    const adults = (qs.get('adults') || '1').trim();
    const cabin = (qs.get('cabin') || 'ECONOMY').trim();
    const src = (qs.get('src') || '').trim();

    const isIata = (x) => /^[A-Z]{3}$/.test(x);
    const isISODate = (x) => /^\d{4}-\d{2}-\d{2}$/.test(x);

    const summaryPills = document.getElementById('summaryPills');
    const results = document.getElementById('results');
    const errorBox = document.getElementById('errorBox');
    const resultsHint = document.getElementById('resultsHint');

    document.getElementById('btnNewSearch').addEventListener('click', () => {
      window.location.href = 'index.html#home-search';
    });

    document.getElementById('btnModify').addEventListener('click', () => {
      window.location.href = 'index.html#home-search';
    });

    function setError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
    }

    function setPills() {
      summaryPills.innerHTML = `
        <div class="pill">${from || '—'} → ${to || '—'}</div>
        <div class="pill">${date || '—'}</div>
        <div class="pill">${cabin} • ${adults} passenger${Number(adults) > 1 ? 's' : ''}</div>
      `;
    }

    setPills();

    // Guard: do not allow random results / broken states
    const valid = isIata(from) && isIata(to) && from !== to && isISODate(date) && Number(adults) >= 1 && Number(adults) <= 9;

    if (!valid) {
      resultsHint.textContent = 'No results yet.';
      setError('Please start a search from the Home page with valid airports and a date.');
      results.innerHTML = `
        <div style="margin-top:1rem;">
          <button class="btn btn-primary" onclick="location.href='index.html#home-search'">Go to Home Search</button>
        </div>
      `;
    } else {
      resultsHint.textContent = 'Fetching flights…';

      // Call backend
      const apiUrl = new URL('/api/amadeus/search', window.location.origin);
      apiUrl.searchParams.set('from', from);
      apiUrl.searchParams.set('to', to);
      apiUrl.searchParams.set('date', date);
      apiUrl.searchParams.set('adults', adults);

      fetch(apiUrl.toString())
        .then(async (r) => {
          const data = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(data?.message || data?.error || 'Search failed');
          return data;
        })
        .then((data) => {
          errorBox.style.display = 'none';
          const flights = Array.isArray(data?.flights) ? data.flights : [];
          resultsHint.textContent = flights.length ? `${flights.length} flights found` : 'No flights found for this route/date.';

          results.innerHTML = flights.map(f => `
            <div class="flight">
              <div class="flight-top">
                <div>
                  <div style="font-weight:900; color:#fff; font-size:1.05rem;">
                    ${escapeHtml(f.airline || f.airlineCode || 'Airline')} • ${escapeHtml(f.code || '')}
                  </div>
                  <div class="muted" style="margin-top:0.25rem;">
                    ${escapeHtml(f.departAirport || from)} ${escapeHtml(f.departTime || '')}
                    → ${escapeHtml(f.arriveAirport || to)} ${escapeHtml(f.arriveTime || '')}
                    • ${escapeHtml(f.stopInfo || (f.stops === 0 ? 'Non-stop' : `${f.stops} stops`))}
                    ${f.duration ? ` • ${escapeHtml(f.duration)}` : ''}
                  </div>
                </div>
                <div class="price">
                  $${Number(f.price || 0).toLocaleString()}
                </div>
              </div>
            </div>
          `).join('');
        })
        .catch((err) => {
          resultsHint.textContent = 'Couldn’t load flights.';
          setError(err.message || 'Search failed');
        });
    }

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>
</body>
</html>
